#!/usr/bin/env python3
"""
Douyin (TikTok China) Auto-Publish Skill

Automatically uploads videos to Douyin Creator Center via browser automation.
"""

import os
import sys
import json
import time

# Video output directory
VIDEOS_DIR = os.path.expanduser("~/Videos/tiktok-industrial")

# Douyin Creator Center URL
DOUYIN_URL = "https://creator.douyin.com/content/upload"


def get_latest_video():
    """Get the most recently created video file."""
    if not os.path.exists(VIDEOS_DIR):
        return None
    
    videos = [f for f in os.listdir(VIDEOS_DIR) if f.endswith('.mp4')]
    if not videos:
        return None
    
    # Sort by modification time, newest first
    videos.sort(key=lambda x: os.path.getmtime(os.path.join(VIDEOS_DIR, x)), reverse=True)
    return videos[0]


def list_pending_videos():
    """List videos that haven't been published yet."""
    publish_log = os.path.expanduser("~/.openclaw/logs/douyin-published.json")
    
    published = set()
    if os.path.exists(publish_log):
        try:
            with open(publish_log, 'r') as f:
                published = set(json.load(f))
        except:
            pass
    
    videos = []
    for f in os.listdir(VIDEOS_DIR):
        if f.endswith('.mp4') and f not in published:
            filepath = os.path.join(VIDEOS_DIR, f)
            videos.append({
                "filename": f,
                "path": filepath,
                "size": os.path.getsize(filepath),
                "modified": os.path.getmtime(filepath)
            })
    
    videos.sort(key=lambda x: x['modified'], reverse=True)
    return videos


def publish_video(filename, title, description, hashtags):
    """Create publish script for browser automation."""
    
    filepath = os.path.join(VIDEOS_DIR, filename)
    if not os.path.exists(filepath):
        return {"error": f"File not found: {filepath}"}
    
    # Update publish log
    publish_log = os.path.expanduser("~/.openclaw/logs/douyin-published.json")
    published = set()
    if os.path.exists(publish_log):
        try:
            with open(publish_log, 'r') as f:
                published = set(json.load(f))
        except:
            pass
    
    published.add(filename)
    os.makedirs(os.path.dirname(publish_log), exist_ok=True)
    with open(publish_log, 'w') as f:
        json.dump(list(published), f)
    
    return {
        "success": True,
        "filename": filename,
        "filepath": filepath,
        "title": title,
        "description": description,
        "hashtags": hashtags,
        "status": "ready_for_publish"
    }


def create_automation_script(filename, title, description, hashtags):
    """Create a browser automation script for publishing."""
    
    script_content = f'''#!/usr/bin/env python3
"""
Auto-publish script for Douyin - Generated by OpenClaw
Video: {filename}
"""

import sys
import os
sys.path.insert(0, '{os.path.dirname(os.path.dirname(os.path.abspath(__file__)))}')

from skills.desktop_control import DesktopController

def publish_to_douyin():
    dc = DesktopController()
    
    print("ğŸ¬ Starting Douyin upload automation...")
    
    # Open Chrome to Douyin Creator Center
    print("ğŸ“± Opening Douyin Creator Center...")
    os.system("open -a 'Google Chrome' '{DOUYIN_URL}'")
    time.sleep(3)
    
    # Click upload button (coordinates may vary - adjust as needed)
    print("â¬†ï¸ Clicking upload button...")
    # dc.click(800, 300)  # Adjust coordinates for upload button
    
    # For reference, here's the typical flow:
    # 1. Click "ä¸Šä¼ è§†é¢‘" button
    # 2. Select video file: {filename}
    # 3. Wait for processing
    # 4. Fill in title: {title}
    # 5. Fill in description: {description}
    # 6. Add hashtags: {hashtags}
    # 7. Click "å‘å¸ƒ" button
    
    print("âš ï¸ Please complete the upload manually this time.")
    print(f"ğŸ“¹ Video: {filename}")
    print(f"ğŸ“ Title: {{title}}")
    print(f"ğŸ“„ Description: {{description}}")
    print(f"ğŸ·ï¸ Hashtags: {{hashtags}}")

if __name__ == "__main__":
    publish_to_douyin()
'''
    
    script_path = os.path.join(os.path.dirname(__file__), "douyin-publish-temp.py")
    with open(script_path, 'w') as f:
        f.write(script_content)
    
    os.chmod(script_path, 0o755)
    return script_path


def main():
    import argparse
    
    parser = argparse.ArgumentParser(description='Douyin Auto-Publish Tool')
    parser.add_argument('command', choices=['list', 'publish', 'generate'],
                       help='Command to execute')
    parser.add_argument('--file', '-f', help='Specific video file to publish')
    parser.add_argument('--title', '-t', help='Video title')
    parser.add_argument('--desc', '-d', help='Video description')
    parser.add_argument('--tags', help='Hashtags (comma separated)')
    parser.add_argument('--auto', action='store_true',
                       help='Auto-generate title/desc from theme')
    
    args = parser.parse_args()
    
    if args.command == 'list':
        print("\nğŸ¬ Videos pending publication:\n")
        pending = list_pending_videos()
        if not pending:
            print("  âœ… All videos have been published!")
        for i, video in enumerate(pending):
            print(f"  {i+1}. {video['filename']} ({video['size']/1024/1024:.1f} MB)")
        print()
        
    elif args.command == 'generate':
        # Auto-generate title/desc if not provided
        filename = args.file or get_latest_video()
        if not filename:
            print("âŒ No video found")
            sys.exit(1)
        
        # Extract theme from filename
        theme = filename.split('_')[0]
        
        # Default content based on theme
        content_map = {
            'cnc': {
                'title': 'ğŸ”§ é“å—å˜æˆè‰ºæœ¯å“çš„è¿‡ç¨‹ å¤ªçˆ½äº†ï¼é‡‘å±å±‘é£èˆçš„é‚£ä¸€åˆ»ç»äº† âœ¨',
                'desc': 'CNCæ•°æ§æœºåºŠåœ¨é“æä¸Šé›•åˆ»å¤æ‚å›¾æ¡ˆï¼Œé‡‘å±å±‘é£æº…ï¼Œå…‰æ»‘è¡¨é¢é€æ¸æ˜¾ç°ã€‚ç²¾å¯†åˆ¶é€ çš„è‰ºæœ¯ï¼',
                'tags': 'CNC,é‡‘å±åŠ å·¥,åˆ¶é€ ä¸š,å·¥ä¸š,è§£å‹,æŠ€æœ¯,fyp,viral'
            },
            'laser': {
                'title': 'ğŸªµ æ¿€å…‰é›•åˆ»æœ¨å¤´çš„è¿‡ç¨‹å¤ªé­”æ€§äº†ï¼çƒŸé›¾å‡èµ· å›¾æ¡ˆé€æ¸æ˜¾ç° âœ¨',
                'desc': 'æ¿€å…‰åœ¨æœ¨å¤´ä¸Šé›•åˆ»å¤æ‚èŠ±çº¹ï¼ŒçƒŸé›¾è¢…è¢…å‡èµ·ï¼Œè®¾è®¡é€æ¸æ˜¾ç°ã€‚æœ¨å¤´ä¸ç«çš„å®Œç¾ç»“åˆï¼',
                'tags': 'æ¿€å…‰é›•åˆ»,æœ¨å·¥,è§£å‹,åˆ¶é€ ä¸š,diy,viral,fyp'
            },
            'welding': {
                'title': 'âœ¨ ç„Šæ¥ç«èŠ±çš„æ…¢é•œå¤´ ç»äº†ï¼é‡‘å±è¿æ¥çš„ç¬é—´å¤ªæ²»æ„ˆäº† âœ¨',
                'desc': 'ç„Šæ¥ç«èŠ±æ…¢é•œå¤´é£èˆï¼Œä¸¤å—é‡‘å±é€æ¸è¿æ¥åœ¨ä¸€èµ·ã€‚å·¥ä¸šç‰ˆçš„æµªæ¼«ï¼',
                'tags': 'ç„Šæ¥,ç«èŠ±,å·¥ä¸š,è§£å‹,åˆ¶é€ ä¸š,viral,fyp'
            },
            'hydraulic-press': {
                'title': 'ğŸ’¥ æ¶²å‹æœºç²‰ç¢ç‰©ä½“ å‹åŠ›å…¨éƒ¨é‡Šæ”¾ï¼æ…¢é•œå¤´çœ‹æ›´çˆ½ âœ¨',
                'desc': 'æ¶²å‹æœºç¼“æ…¢å‹ç¢å„ç§ç‰©ä½“ï¼Œæ…¢é•œå¤´æ•æ‰æ¯ä¸€ä¸ªå˜å½¢ç¬é—´ã€‚å‹åŠ›è·Ÿç€ç‰©ä½“ä¸€èµ·ç²‰ç¢ï¼',
                'tags': 'æ¶²å‹æœº,è§£å‹,ç²‰ç¢,å‹åŠ›é‡Šæ”¾,viral,fyp'
            },
            '3d-printing': {
                'title': 'ğŸ–¨ï¸ 3Dæ‰“å°ä»0åˆ°1çš„è¿‡ç¨‹å¤ªè§£å‹äº†ï¼çœ‹å®Œæ•´ä¸ªäººéƒ½èˆ’æœäº† âœ¨',
                'desc': '3Dæ‰“å°æœºä¸€å±‚ä¸€å±‚åˆ¶ä½œå®Œç¾ç‰©ä½“ï¼Œè€—ææŒ¤å‡ºçš„è¿‡ç¨‹è¶…æ²»æ„ˆã€‚å…¨ç¨‹è‡ªåŠ¨çœ‹ç€å°±è§£å‹ï¼',
                'tags': '3Dæ‰“å°,è§£å‹,ASMR,åˆ¶é€ ä¸š,å·¥ä¸š,æŠ€æœ¯,è§£å‹è§†é¢‘,æ²»æ„ˆ,viral,fyp'
            },
            'injection-molding': {
                'title': 'ğŸ¥¤ å¡‘æ–™æ¯ä»æ— åˆ°æœ‰çš„è¿‡ç¨‹å¤ªæ²»æ„ˆäº†ï¼å·¥ä¸šç”Ÿäº§æ‰æ˜¯çœŸæ­£çš„è§£å‹ âœ¨',
                'desc': 'æ³¨å¡‘æœºæ‰¹é‡ç”Ÿäº§å®Œç¾å¡‘æ–™æ¯ï¼Œæµæ°´çº¿æ•ˆç‡ä¸æ²»æ„ˆå¹¶å­˜ã€‚æ¯å¤©éƒ½åœ¨ç”¨çš„ä¸œè¥¿æ˜¯è¿™æ ·æ¥çš„ï¼',
                'tags': 'æ³¨å¡‘,å·¥ä¸šç”Ÿäº§,åˆ¶é€ ä¸š,è§£å‹,viral,fyp'
            }
        }
        
        content = content_map.get(theme, {
            'title': f'ğŸ¬ {filename}',
            'desc': 'å·¥ä¸šè§£å‹è§†é¢‘ #åˆ¶é€ ä¸š #è§£å‹',
            'tags': 'åˆ¶é€ ä¸š,è§£å‹,å·¥ä¸š,viral,fyp'
        })
        
        print(f"\nğŸ“¹ Video: {filename}")
        print(f"ğŸ·ï¸ Title: {content['title']}")
        print(f"ğŸ“ Description: {content['desc']}")
        print(f"ğŸ·ï¸ Hashtags: {content['tags']}")
        
        # Save to publish queue
        result = publish_video(filename, content['title'], content['desc'], content['tags'])
        print(f"\nâœ… Ready for upload! Run: douyin-publish publish --file {filename}")
        
    elif args.command == 'publish':
        if not args.file:
            print("âŒ Please specify a file: --file <filename>")
            sys.exit(1)
        
        filename = args.file
        title = args.title or "ğŸ¬ æ–°è§†é¢‘å‘å¸ƒ"
        description = args.desc or ""
        hashtags = args.tags or ""
        
        result = publish_video(filename, title, description, hashtags)
        if 'error' in result:
            print(f"âŒ Error: {{result['error']}}")
            sys.exit(1)
        
        print(f"\nâœ… Video queued for Douyin upload:")
        print(f"   ğŸ“¹ {filename}")
        print(f"   ğŸ·ï¸ {title}")
        
        # Create automation script
        script = create_automation_script(filename, title, description, hashtags)
        print(f"\nğŸ“œ Automation script: {{script}}")
        print("âš ï¸ Run this script to start browser automation")


if __name__ == "__main__":
    main()

#!/usr/bin/env python3
"""
Video Uploader - Quick Test Script
Tests login and upload for all platforms
"""

import sys
import asyncio
from pathlib import Path

# Setup path
SKILL_DIR = Path(__file__).parent
SCRIPTS_DIR = SKILL_DIR / "scripts"
sys.path.insert(0, str(SCRIPTS_DIR))

# Create credentials directory
CREDENTIALS_DIR = SKILL_DIR / "credentials"
for platform in ["douyin", "tiktok", "kuaishou", "tencent"]:
    (CREDENTIALS_DIR / platform).mkdir(parents=True, exist_ok=True)


async def test_douyin():
    """Test Douyin login and upload"""
    print("\n" + "="*50)
    print("æµ‹è¯• 1: æŠ–éŸ³ Douyin")
    print("="*50)
    
    from douyin_uploader.main import douyin_cookie_gen, cookie_auth, DouYinVideo
    
    # Test login
    cookie_file = CREDENTIALS_DIR / "douyin" / "storage.json"
    
    if cookie_file.exists():
        print(f"ğŸ“ å‘ç°å·²æœ‰ Cookie: {cookie_file}")
        if await cookie_auth(str(cookie_file)):
            print("âœ… Cookie æœ‰æ•ˆ")
        else:
            print("âš ï¸ Cookie æ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•")
            await douyin_cookie_gen(str(cookie_file))
    else:
        print("ğŸ“ æ²¡æœ‰ Cookieï¼Œå¼€å§‹ç™»å½•...")
        await douyin_cookie_gen(str(cookie_file))
    
    if cookie_file.exists():
        print(f"âœ… Cookie å·²ä¿å­˜: {cookie_file} ({cookie_file.stat().st_size} bytes)")
        print("\nğŸš€ æµ‹è¯•ä¸Šä¼ ...")
        
        video = DouYinVideo(
            title="è‡ªåŠ¨æµ‹è¯•è§†é¢‘",
            file_path=str(Path.home() / "Videos/dog_wagging_tail.mp4"),
            tags=["æµ‹è¯•", "è‡ªåŠ¨åŒ–"],
            publish_date=0,
            account_file=str(cookie_file)
        )
        await video.main()
        return True
    
    return False


async def test_tiktok():
    """Test TikTok login"""
    print("\n" + "="*50)
    print("æµ‹è¯• 2: TikTok")
    print("="*50)
    
    from tk_uploader.main import get_tiktok_cookie, cookie_auth, TiktokVideo
    
    cookie_file = CREDENTIALS_DIR / "tiktok" / "storage.json"
    
    if cookie_file.exists():
        print(f"ğŸ“ å‘ç°å·²æœ‰ Cookie: {cookie_file}")
        # TikTok cookie_auth uses different path
    else:
        print("ğŸ“ æ²¡æœ‰ Cookieï¼Œå¼€å§‹ç™»å½•...")
        print("âš ï¸ æµè§ˆå™¨å°†æ‰“å¼€ï¼Œè¯·åœ¨æ‰‹æœºä¸Šæ‰«ç ç™»å½•")
        await get_tiktok_cookie(str(cookie_file))
    
    if cookie_file.exists():
        print(f"âœ… Cookie å·²ä¿å­˜: {cookie_file}")
        return True
    
    return False


async def test_kuaishou():
    """Test Kuaishou login"""
    print("\n" + "="*50)
    print("æµ‹è¯• 3: å¿«æ‰‹ Kuaishou")
    print("="*50)
    
    from ks_uploader.main import get_ks_cookie, cookie_auth
    
    cookie_file = CREDENTIALS_DIR / "kuaishou" / "storage.json"
    
    if cookie_file.exists():
        print(f"ğŸ“ å‘ç°å·²æœ‰ Cookie: {cookie_file}")
    else:
        print("ğŸ“ æ²¡æœ‰ Cookieï¼Œå¼€å§‹ç™»å½•...")
        print("âš ï¸ æµè§ˆå™¨å°†æ‰“å¼€ï¼Œè¯·æ‰«ç ç™»å½•")
        await get_ks_cookie(str(cookie_file))
    
    if cookie_file.exists():
        print(f"âœ… Cookie å·²ä¿å­˜: {cookie_file}")
        return True
    
    return False


async def test_tencent():
    """Test Tencent/WeChat login"""
    print("\n" + "="*50)
    print("æµ‹è¯• 4: è§†é¢‘å· Tencent/WeChat")
    print("="*50)
    
    from tencent_uploader.main import get_tencent_cookie
    
    cookie_file = CREDENTIALS_DIR / "tencent" / "storage.json"
    
    if cookie_file.exists():
        print(f"ğŸ“ å‘ç°å·²æœ‰ Cookie: {cookie_file}")
    else:
        print("ğŸ“ æ²¡æœ‰ Cookieï¼Œå¼€å§‹ç™»å½•...")
        print("âš ï¸ æµè§ˆå™¨å°†æ‰“å¼€ï¼Œè¯·æ‰«ç ç™»å½•")
        await get_tencent_cookie(str(cookie_file))
    
    if cookie_file.exists():
        print(f"âœ… Cookie å·²ä¿å­˜: {cookie_file}")
        return True
    
    return False


async def main():
    """Main test function"""
    print("\n" + "="*60)
    print("ğŸ¬ è§†é¢‘ä¸Šä¼ å™¨ - å®Œæ•´æµ‹è¯•")
    print("="*60)
    
    # Test each platform
    results = {}
    
    # 1. Douyin
    try:
        results["douyin"] = await test_douyin()
    except Exception as e:
        print(f"âŒ æŠ–éŸ³æµ‹è¯•å¤±è´¥: {e}")
        results["douyin"] = False
    
    # 2. TikTok
    try:
        results["tiktok"] = await test_tiktok()
    except Exception as e:
        print(f"âŒ TikTok æµ‹è¯•å¤±è´¥: {e}")
        results["tiktok"] = False
    
    # 3. Kuaishou
    try:
        results["kuaishou"] = await test_kuaishou()
    except Exception as e:
        print(f"âŒ å¿«æ‰‹æµ‹è¯•å¤±è´¥: {e}")
        results["kuaishou"] = False
    
    # 4. Tencent
    try:
        results["tencent"] = await test_tencent()
    except Exception as e:
        print(f"âŒ è§†é¢‘å·æµ‹è¯•å¤±è´¥: {e}")
        results["tencent"] = False
    
    # Summary
    print("\n" + "="*60)
    print("ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»")
    print("="*60)
    
    for platform, success in results.items():
        status = "âœ… é€šè¿‡" if success else "âŒ å¤±è´¥"
        print(f"  {platform:15} {status}")
    
    print()


if __name__ == "__main__":
    asyncio.run(main())

#!/usr/bin/env python3
"""
TikTok Industrial Video + Douyin Upload Pipeline
Generate industrial ASMR video and upload to Douyin
"""

import asyncio
import subprocess
import sys
from pathlib import Path
from datetime import datetime


async def generate_video(theme: str) -> str:
    """Generate TikTok Industrial video using subprocess"""
    print(f"\nğŸ¬ Step 1: Generate {theme} video...")
    
    # Run TikTok Industrial generator
    tiktok_skill = Path.home() / ".openclaw/workspace/skills/tiktok-industrial-relaxing/bin/tiktok-industrial"
    
    proc = await asyncio.create_subprocess_exec(
        sys.executable, str(tiktok_skill), "generate", theme,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.STDOUT
    )
    
    output = []
    while True:
        line = await proc.stdout.readline()
        if not line:
            break
        text = line.decode().strip()
        output.append(text)
        print(f"  {text}")
    
    await proc.wait()
    
    if proc.returncode != 0:
        print(f"âŒ Failed to generate video!")
        return None
    
    # Find the generated video
    video_dir = Path.home() / "Videos" / "tiktok-industrial"
    if video_dir.exists():
        # Get most recent video
        videos = sorted(video_dir.glob(f"{theme}_*.mp4"), key=lambda x: x.stat().st_mtime, reverse=True)
        if videos:
            return str(videos[0])
    
    print(f"âŒ Could not find generated video!")
    return None


async def upload_to_douyin(video_path: str, title: str, tags: list):
    """Upload video to Douyin"""
    # Add douyin skill to path
    douyin_skill_dir = Path(__file__).parent.parent
    sys.path.insert(0, str(douyin_skill_dir / "scripts"))
    
    from douyin_uploader.main import DouYinVideo
    
    print(f"\nğŸš€ Step 2: Upload to Douyin...")
    
    cookie_file = douyin_skill_dir / "credentials" / "douyin" / "storage.json"
    
    if not cookie_file.exists():
        print("âŒ Douyin cookie not found! Please login first:")
        print(f"   cd {douyin_skill_dir}")
        print("   PYTHONPATH=scripts python3 bin/login-douyin")
        return False
    
    video = DouYinVideo(
        title=title,
        file_path=video_path,
        tags=tags,
        publish_date=0,
        account_file=str(cookie_file),
        thumbnail_path=None  # Auto-capture from video
    )
    
    await video.main()
    return True


async def log_to_sheet(video_path: str, platform: str, status: str, title_cn: str, tags: list):
    """Log to Google Sheet using the tracker skill"""
    import subprocess
    
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    video_name = Path(video_path).name
    
    # Call the Google Sheets tracker skill
    cmd = [
        sys.executable,
        str(Path.home() / ".openclaw/workspace/skills/google-sheets-tracker/bin/google-sheets-tracker"),
        "log",
        video_name,
        video_path,
        title_cn,
        "",
        ",".join(tags) if isinstance(tags, list) else tags,
        "",
        platform
    ]
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    
    print(f"\nğŸ“‹ Sheet Log:")
    print(f"   æ—¶é—´: {timestamp}")
    print(f"   è§†é¢‘: {video_name}")
    print(f"   å¹³å°: {platform}")
    print(f"   çŠ¶æ€: {'âœ… æˆåŠŸ' if result.returncode == 0 else 'âŒ å¤±è´¥'}")
    
    return result.returncode == 0


async def main():
    """Main pipeline"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description='Generate industrial video and upload to Douyin'
    )
    parser.add_argument(
        '--theme', 
        default='hydraulic-press',
        help='Video theme (default: hydraulic-press)'
    )
    parser.add_argument(
        '--title',
        required=True,
        help='Video title for Douyin'
    )
    parser.add_argument(
        '--tags',
        default='å·¥ä¸š,è§£å‹,æ¶²å‹æœº',
        help='Tags for Douyin (comma-separated)'
    )
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("ğŸ¬ TikTok Industrial + Douyin Upload Pipeline")
    print("=" * 60)
    
    # Step 1: Generate video
    video_path = await generate_video(args.theme)
    
    if not video_path:
        print("\nâŒ Pipeline failed at video generation!")
        await log_to_sheet("", "Douyin", "å¤±è´¥ - è§†é¢‘ç”Ÿæˆå¤±è´¥")
        return
    
    print(f"\nâœ… Video generated: {video_path}")
    
    # Step 2: Upload to Douyin
    tags = [t.strip() for t in args.tags.split(',')]
    success = await upload_to_douyin(video_path, args.title, tags)
    
    if success:
        print("\n" + "=" * 60)
        print("ğŸ‰ Pipeline completed successfully!")
        print("=" * 60)
        await log_to_sheet(video_path, "Douyin", "æˆåŠŸ", args.title, tags)
    else:
        print("\nâŒ Upload failed!")
        await log_to_sheet(video_path, "Douyin", "å¤±è´¥ - ä¸Šä¼ å¤±è´¥", args.title, tags)
        sys.exit(1)


if __name__ == "__main__":
    asyncio.run(main())
